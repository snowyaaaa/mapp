// ==UserScript==
// @name         TEST NEW MAP
// @namespace    http://tampermonkey.net/
// @version      2024-02-22:1
// @description  try to take over the world!
// @author       Artak : beta testers Sallbet
// @match      *://pixelplanet.fun/*
// @match      *://fuckyouarkeros.fun/*
// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==
// @grant        none
// ==/UserScript==
(()=>{"use strict";var t={d:(e,n)=>{for(var a in n)t.o(n,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:n[a]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};function e(t){return"object"==typeof t&&(!!t.dispatch&&(!!t.getState&&!!t.subscribe))}function n(t){if(0!==t.tag||!t.child)return;if(10!==t.child.tag)return;if(!t.child.memoizedProps)return;const n=t.child.memoizedProps.value?.store;if(!e(n))return;const a=t.memoizedProps?.store;return e(a)&&n===a?a:void 0}function a(){const t=document.getElementById("app");if(!t)throw new Error("Couldn't find React root container");const e=function(t){const e=Object.keys(t).filter((t=>t.startsWith("__reactContainer")))[0];if(!e)throw new Error("couldn't find internal react root");let a=t[e];for(;a.child;){const t=n(a);if(t)return t;a=a.child}}(t);if(!e)throw new Error("Couldn't find Redux store");return e}function i(t){return o().getState().canvas[t]}function o(){return a()}function r(t){o().dispatch(t)}async function s(t,e){if(g>0)return;g++;const n=256,{x:a,y:o}=t,[r,s]=e,h=i("canvasSize")/2,c=t.errors.getContext("2d"),d=document.createElement("canvas"),l=d.getContext("2d");d.width=256,d.height=256;const u=Math.floor((r-a)/n)*n-512,m=Math.floor((s-o)/n)*n-512,f=[];for(let t=u;t<=u+1024;t+=n)for(let e=m;e<=m+1024;e+=n)f.push([a+t,o+e]);const w=f.reduce(((e,n,r)=>{const s=async function(t){const e=i("canvasSize")/2;return[Math.floor((t[0]+e)/256),Math.floor((t[1]+e)/256)]}(n).then((async e=>{const[n,r]=e;if(!t.chunks.some((([t,e])=>t===256*n-h&&e===256*r-h))){t.chunks.push([256*n-h,256*r-h]);const[s,u,m]=await async function(t){const e=await fetch("https://fuckyouarkeros.fun/chunks/"+i("canvasId")+"/"+t[0]+"/"+t[1]+".bmp"),n=await e.arrayBuffer(),a=new Uint8Array(n),o=new Uint8Array([...a,...new Uint8Array(65536-a.length).fill(0)]);let r=[];const s=i("palette").rgb;o.forEach((t=>{const e=3*t;r.push(s[e],s[e+1],s[e+2],255)}));const h=new ImageData(new Uint8ClampedArray(r),256,256),c=i("canvasSize")/2;return[h,256*t[0]-c,256*t[1]-c]}(e);l.clearRect(0,0,d.width,d.height);const g=await async function(t,e,n,a,i){t.drawImage(e,n,a,256,256,0,0,256,256);const o=t.getImageData(0,0,256,256).data,r=i.data;for(let t=0;t<o.length;t+=4)0===o[t+3]?(r[t]=0,r[t+1]=0,r[t+2]=0,r[t+3]=0):o[t+0]===r[t+0]&&o[t+1]===r[t+1]&&o[t+2]===r[t+2]?(r[t]=0,r[t+1]=255,r[t+2]=0,r[t+3]=255):(r[t]=255,r[t+1]=0,r[t+2]=0,r[t+3]=255);return new ImageData(r,256,256)}(l,t.data,-1*(a-u),-1*(o-m),s);c.putImageData(g,-1*(a-u),-1*(o-m))}}));return e.push(s),10===e.length||r===f.length-1?[...e]:e}),[]);await Promise.all(w),g--}function h(t,e,n,[a,i],o,r){const s=256*e-o+a-256*Math.floor(a/256)-t.x,h=256*n-o+Math.floor(a/256)-t.y;i*=3,t.ChekAndSet(s,h,r[i+0],r[i+1],r[i+2])}t.d({},{Y:()=>g});class c{constructor(t,e,n,a,i,o){const r=document.createElement("canvas");r.width=i,r.height=o,this.name=t,this.data=a,this.x=e,this.y=n,this.width=i,this.height=o,this.errors=r,this.chunks=[],this.ctxErr=this.errors.getContext("2d"),this.ctxData=this.data.getContext("2d"),this.RealData=this.GetImageData(this.data),this.ctxData.imageSmoothingEnabled=!1,this.ctxData.mozImageSmoothingEnabled=!1,this.ctxData.webkitImageSmoothingEnabled=!1,this.ctxData.msImageSmoothingEnabled=!1,this.ctxErr.imageSmoothingEnabled=!1,this.ctxErr.mozImageSmoothingEnabled=!1,this.ctxErr.webkitImageSmoothingEnabled=!1,this.ctxErr.msImageSmoothingEnabled=!1}GetImageData(t){return t.getContext("2d").getImageData(0,0,this.width,this.height)}GetCtx(t){return t.getContext("2d")}GetIndex(t,e){return t<0?t=0:t>this.width&&(t=this.width),e<0?e=0:e>this.height&&(e=this.height),this.width*e+t}GetPixColor(t,e,n){return Array.from(t,(t=>t[this.GetIndex(e,n)]))}GetPixColorData(t,e){return Array.from(Array(4),((n,a)=>t.data[4*e+a]))}SetPix(t,e,n,a){t.forEach(((t,i)=>t[this.GetIndex(e,n)]=a[i]))}SetPixdata(t,e,n){this.ctxErr.fillStyle=n,this.ctxErr.fillRect(t,e,1,1)}imageToGrayscale(t){let e=[[],[],[],[]];for(let n=0;n<t.data.length;n+=4)e[0].push(t.data[n]),e[1].push(t.data[n+1]),e[2].push(t.data[n+2]),e[3].push(t.data[n+3]);return[...e]}GrayscaleToImage(t,e){for(let n=0;n<e[0].length;n++)t.data[4*n]=e[0][n],t.data[n+4]=e[1][n],t.data[n+8]=e[2][n],t.data[n+12]=e[3][n];return t}AplyPerPixel(t){let e=this.GetImageData(),n=this.imageToGrayscale(e);for(let e=0;e<this.height;e++)for(let a=0;a<this.width;a++){let i=this.GetPixColor(n,a,e);this.SetPix(n,a,e,t(i))}return this.GrayscaleToImage(e,n)}ChekAndSet(t,e,n,a,i){const o=this.GetPixColorData(this.RealData,this.GetIndex(t,e));0!=o[3]&&(o[0]===n&&o[1]===a&&o[2]===i?this.SetPixdata(t,e,"rgba(0, 255, 0, 255)"):this.SetPixdata(t,e,"rgba(255, 0, 0, 255)"))}InvertColor(t){for(let e in t)t[e]=255-t[e];return t}}class d{constructor(){this.images=[]}}let l=["mine","cal"],u=[],m=1,g=0,f=[],w=new d;function y(t,e){let n=document.createElement(t);for(let t in e)n[t]=e[t];document.body.append(n)}function p(t,e){console.error(t+"  ||--\x3e "+e),alert(t+"  ||--\x3e "+e)}function x(t,e){console.warn(t+"  ||--\x3e "+e)}function E(t){return document.getElementById(t)}function v([t,e,n,a]){if(255!==a)return;console.log(t,e,n,a);const o=i("palette").rgb;for(let a=0;a<o.length;a+=3)o[a]===t&&o[a+1]===e&&o[a+2]===n&&r({type:"SELECT_COLOR",color:a/3})}async function b(t,e){try{return new Promise((n=>{let a=t+e,i=document.createElement("img");i.crossOrigin="Anonymous",i.onload=function(){let t=this.width,e=this.height,a=document.createElement("CANVAS");a.width=this.width,a.height=this.height,a.getContext("2d").drawImage(i,0,0),n([a,t,e])},i.src=a}))}catch(t){p(t,"getNewImage")}}async function I(t,e,n){try{y("CANVAS",{width:e,height:n,id:t,style:"image-rendering: pixelated; border-style: solid; position: absolute; border-width: 1px; right: 0px;"});u.push([E(t),E(t).getContext("2d")])}catch(t){p(t,"crateCanvas")}}async function S(t){try{let e=await async function(t){try{return new Promise((e=>{fetch(t).then((t=>{e(t.json())}))}))}catch(t){p(t,"GetTeampletList")}}("https://raw.githubusercontent.com/TheElderFallouts/wwbtp/main/PP/templates/"+t+".json");y("progress",{id:"loadProgress",max:Object.keys(e).length,value:"0",style:"position: absolute;left: 0px;right: 0px;margin: 0px auto;top: 0px;display: block;padding: 11px;accent-color: lime;"});for(let n in e)w.images.push(new c(e[n].name,e[n].x,e[n].y,...await b("https://raw.githubusercontent.com/TheElderFallouts/wwbtp/main/PP/"+t+"/",e[n].name))),E("loadProgress").value=E("loadProgress").value+1;E("loadProgress").style.display="none"}catch(t){console.error(t),p(t,"LOADAllImages")}}async function C(t,e){return e[0]>=t.x&&e[1]>=t.y&&e[0]<=t.x+t.width&&e[1]<=t.y+t.height}function P(){return m}function D(t,e,n,a,i){try{if(!t||!e||!n.length)return void p("EMPTY","Draw");e[1].drawImage(t,...Array.from(function(t){try{return Array.from([t.width/2,t.height/2],(t=>Math.round(t)))}catch(t){p(t,"GetObjectMid")}}(e[0]),((t,e)=>Math.round(n[e]-i[e])*P()+t-P()/2)),...Array.from(a,((t,e)=>t*P())))}catch(t){p(t,"Draw")}}async function A(){let t=await async function(){return i("hover")?i("hover"):i("view")}();const e=await async function(t,e){const n=[];for(const a of t)await C(a,e)&&n.push(a);return n}(w.images,t);for(let n of e)s(n,t),t[0]==f[0]&&t[1]==f[1]||(f=t,State().getState().gui.mute||r({type:"s/TGL_MUTE"}),v(n.GetPixColorData(n.RealData,n.GetIndex(t[0]-n.x,t[1]-n.y))),r({type:"s/SELECT_HOLD_PAINT",value:0,immediate:0}));u[0][1].clearRect(0,0,u[0][0].width,u[0][0].height),u[0][1].fillStyle="#95a3b0",u[0][1].fillRect(0,0,u[0][0].width,u[0][0].height),u[1][1].clearRect(0,0,u[0][0].width,u[0][0].height);let n=w.images.filter((e=>async function(t,e,n){return e[0]-n<t.x&&e[1]-n<t.y&&e[0]+n>t.x+t.width&&e[1]+n>t.y+t.height}(e,t,4500)));n.forEach((e=>D(e.data,u[0],[e.x,e.y],[e.width,e.height],t))),n.forEach((e=>D(e.errors,u[1],[e.x,e.y],[e.width,e.height],t)))}function G(t){t.shiftKey?(console.log("Клавиша Shift нажата"),r({type:"s/SELECT_HOLD_PAINT",value:0,immediate:0})):console.log("Клавиша Shift не нажата")}function L(t){!async function(t,e,n){let a=70,i="resizeCanvass";t+=n[0],e+=n[1];try{for(let n in u)t<a||e<a?(x("the width or height is too small. --\x3e>|| ",i),u[n][0].width=t<=a?a:t,u[n][0].height=e<=a?a:e):t>=window.innerWidth-a||e>=window.innerHeight-a?(x("the width or height is too big. --\x3e>|| ",i),u[n][0].width=t>=window.innerWidth-a?window.innerWidth-a:t,u[n][0].height=e>=window.innerHeight-a?window.innerHeight-a:e):(u[n][0].width=t,u[n][0].height=e),u[n][1].imageSmoothingEnabled=!1;localStorage.setItem("size",[u[0][0].width,u[0][0].height])}catch(t){p(t,i)}}(window.innerWidth-t.pageX,t.pageY,sizee)}async function T(){localStorage.size||localStorage.setItem("size",[500,300]),await S(i("canvasIdent")),await A(),document.addEventListener("mousemove",A),document.addEventListener("keydown",G),u[u.length-1][0].onmousedown=t=>{document.removeEventListener("mousemove",A);let e=[];e[0]=u[0][0].width-(window.innerWidth-t.pageX),e[1]=u[0][0].height-t.pageY,document.addEventListener("mousemove",L),document.onmouseup=async()=>{document.removeEventListener("mousemove",L),document.addEventListener("mousemove",await A)}}}window.pixelPlanetEvents.addListener("setscale",((t,e)=>{m=t,A()})),window.registerPixelUpdates(((t,e,n)=>async function(t,e,n){const a=await GetCords(),o=i("canvasSize")/2,r=i("palette").rgb,s=await filterImagesByCord(MapState.images,a);for(let a of s)n.forEach(((i,s)=>{h(a,t,e,n[s],o,r)}));DrawAllTemp()}(t,e,n))),window.addEventListener("load",(function(){setTimeout((async()=>{await async function(){try{for(let t in l)I(l[t],...localStorage.getItem("size").split(",")),u[t][1].imageSmoothingEnabled=!1}catch(t){p(t,"crateAllCanvass")}}(),T();const t=document.createElement("style");t.innerHTML="\n        @keyframes blink {\n            0% { opacity: 0.0; }\n            50% { opacity: 1.0; }\n            100% { opacity: 0.0; }\n        }\n\n        #cal {\n            animation: blink 5s infinite;\n        }\n        ",(document.head||document.getElementsByTagName("head")[0]).appendChild(t);let e=i("canvasIdent");setInterval((()=>{e!==i("canvasIdent")&&(document.removeEventListener("mousemove",L),document.removeEventListener("mousemove",A),w=new d,e=i("canvasIdent"),T())}),1e3)}),1e3)}))})();
