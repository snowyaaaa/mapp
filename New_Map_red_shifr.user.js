// ==UserScript==
// @name         TEST NEW MAP
// @namespace    http://tampermonkey.net/
// @version      2024-03-19
// @description  try to take over the world!
// @author       Artak : beta testers Sallbet
// @match      *://pixelplanet.fun/*
// @match      *://fuckyouarkeros.fun/*
// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==
// @grant        none
// ==/UserScript==
(()=>{"use strict";var t={d:(e,n)=>{for(var a in n)t.o(n,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:n[a]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};async function e(t,e){const a=[];for(const o of t)await n(o,e)&&a.push(o);return a}async function n(t,e){return e[0]>=t.x&&e[1]>=t.y&&e[0]<=t.x+t.width&&e[1]<=t.y+t.height}function a(t){return"object"==typeof t&&!!t.dispatch&&!!t.getState&&!!t.subscribe}function o(t){if(0!==t.tag||!t.child)return;if(10!==t.child.tag)return;if(!t.child.memoizedProps)return;const e=t.child.memoizedProps.value?.store;if(!a(e))return;const n=t.memoizedProps?.store;return a(n)&&e===n?n:void 0}function i(t){return r().getState().canvas[t]}function r(){return function(){const t=document.getElementById("app");if(!t)throw new Error("Couldn't find React root container");const e=function(t){const e=Object.keys(t).filter((t=>t.startsWith("__reactContainer")))[0];if(!e)throw new Error("couldn't find internal react root");let n=t[e];for(;n.child;){const t=o(n);if(t)return t;n=n.child}}(t);if(!e)throw new Error("Couldn't find Redux store");return e}()}function s(t){r().dispatch(t)}async function c(){return i("hover")?i("hover"):i("view")}t.d({},{y:()=>E});let h=0;async function l(t,e){if(h>0)return;h++;const n=256,{x:a,y:o}=t,[r,s]=e,c=i("canvasSize")/2,l=t.errors.getContext("2d"),d=document.createElement("canvas"),u=d.getContext("2d");d.width=256,d.height=256;const m=Math.floor((r-a)/n)*n-512,g=Math.floor((s-o)/n)*n-512,f=[];for(let t=m;t<=m+1024;t+=n)for(let e=g;e<=g+1024;e+=n)f.push([a+t,o+e]);const w=f.reduce(((e,n,r)=>{const s=async function(t){const e=i("canvasSize")/2;return[Math.floor((t[0]+e)/256),Math.floor((t[1]+e)/256)]}(n).then((async e=>{const[n,r]=e;if(!t.chunks.some((([t,e])=>t===256*n-c&&e===256*r-c))){t.chunks.push([256*n-c,256*r-c]);const[s,h,m]=await async function(t){const e=await fetch("https://fuckyouarkeros.fun/chunks/"+i("canvasId")+"/"+t[0]+"/"+t[1]+".bmp"),n=await e.arrayBuffer(),a=new Uint8Array(n),o=new Uint8Array([...a,...new Uint8Array(65536-a.length).fill(0)]);let r=[];const s=i("palette").rgb;o.forEach((t=>{const e=3*t;r.push(s[e],s[e+1],s[e+2],255)}));const c=new ImageData(new Uint8ClampedArray(r),256,256),h=i("canvasSize")/2;return[c,256*t[0]-h,256*t[1]-h]}(e);u.clearRect(0,0,d.width,d.height);const g=await async function(t,e,n,a,o){t.drawImage(e,n,a,256,256,0,0,256,256);const i=t.getImageData(0,0,256,256).data,r=o.data;for(let t=0;t<i.length;t+=4)0===i[t+3]?(r[t]=0,r[t+1]=0,r[t+2]=0,r[t+3]=0):i[t+0]===r[t+0]&&i[t+1]===r[t+1]&&i[t+2]===r[t+2]?(r[t]=0,r[t+1]=255,r[t+2]=0,r[t+3]=255):(r[t]=255,r[t+1]=0,r[t+2]=0,r[t+3]=255);return new ImageData(r,256,256)}(u,t.data,-1*(a-h),-1*(o-m),s);l.putImageData(g,-1*(a-h),-1*(o-m))}}));return e.push(s),10===e.length||r===f.length-1?[...e]:e}),[]);await Promise.all(w),h--}function d(t,e,n,[a,o],i,r){const s=256*e-i+a-256*Math.floor(a/256)-t.x,c=256*n-i+Math.floor(a/256)-t.y;o*=3,t.ChekAndSet(s,c,r[o+0],r[o+1],r[o+2])}class u{constructor(t,e,n,a,o,i){const r=document.createElement("canvas");r.width=o,r.height=i,this.name=t,this.data=a,this.x=e,this.y=n,this.width=o,this.height=i,this.errors=r,this.chunks=[],this.ctxErr=this.errors.getContext("2d"),this.ctxData=this.data.getContext("2d"),this.RealData=this.GetImageData(this.data),this.ctxData.imageSmoothingEnabled=!1,this.ctxData.mozImageSmoothingEnabled=!1,this.ctxData.webkitImageSmoothingEnabled=!1,this.ctxData.msImageSmoothingEnabled=!1,this.ctxErr.imageSmoothingEnabled=!1,this.ctxErr.mozImageSmoothingEnabled=!1,this.ctxErr.webkitImageSmoothingEnabled=!1,this.ctxErr.msImageSmoothingEnabled=!1}GetImageData(t){return t.getContext("2d").getImageData(0,0,this.width,this.height)}GetCtx(t){return t.getContext("2d")}GetIndex(t,e){return t<0?t=0:t>this.width&&(t=this.width),e<0?e=0:e>this.height&&(e=this.height),this.width*e+t}GetPixColor(t,e,n){return Array.from(t,(t=>t[this.GetIndex(e,n)]))}GetPixColorData(t,e){return Array.from(Array(4),((n,a)=>t.data[4*e+a]))}SetPix(t,e,n,a){t.forEach(((t,o)=>t[this.GetIndex(e,n)]=a[o]))}SetPixdata(t,e,n){this.ctxErr.fillStyle=n,this.ctxErr.fillRect(t,e,1,1)}imageToGrayscale(t){let e=[[],[],[],[]];for(let n=0;n<t.data.length;n+=4)e[0].push(t.data[n]),e[1].push(t.data[n+1]),e[2].push(t.data[n+2]),e[3].push(t.data[n+3]);return[...e]}GrayscaleToImage(t,e){for(let n=0;n<e[0].length;n++)t.data[4*n]=e[0][n],t.data[n+4]=e[1][n],t.data[n+8]=e[2][n],t.data[n+12]=e[3][n];return t}AplyPerPixel(t){let e=this.GetImageData(),n=this.imageToGrayscale(e);for(let e=0;e<this.height;e++)for(let a=0;a<this.width;a++){let o=this.GetPixColor(n,a,e);this.SetPix(n,a,e,t(o))}return this.GrayscaleToImage(e,n)}ChekAndSet(t,e,n,a,o){const i=this.GetPixColorData(this.RealData,this.GetIndex(t,e));0!=i[3]&&(i[0]===n&&i[1]===a&&i[2]===o?this.SetPixdata(t,e,"rgba(0, 255, 0, 255)"):this.SetPixdata(t,e,"rgba(255, 0, 0, 255)"))}InvertColor(t){for(let e in t)t[e]=255-t[e];return t}}class m{constructor(){this.images=[],this.loadNewImages=!1}}const g="TheElderFallouts",f="wwbtp";let w=["mine","cal"],y=[],p=1,x=[],E=new m,v=[];function I(t,e){let n=document.createElement(t);for(let t in e)n[t]=e[t];document.body.append(n)}function b(t,e){console.error(t.message+"  ||--\x3e "+e),alert(t+"  ||--\x3e "+e)}function S(t,e){console.warn(t.message+"  ||--\x3e "+e)}function P(t){return document.getElementById(t)}function C([t,e,n,a]){if(255!==a)return;console.log(t,e,n,a);const o=i("palette").rgb;for(let a=0;a<o.length;a+=3)o[a]===t&&o[a+1]===e&&o[a+2]===n&&s({type:"SELECT_COLOR",color:a/3})}async function D(t,e,n){try{I("CANVAS",{width:e,height:n,id:t,style:"image-rendering: pixelated; border-style: solid; position: absolute; border-width: 1px; right: 0px;"}),y.push([P(t),P(t).getContext("2d")])}catch(t){b(t,"crateCanvas")}}async function A(t,e,n){const a=await async function(t,e){try{return new Promise((n=>{let a=t+e,o=document.createElement("img");o.crossOrigin="Anonymous",o.onload=function(){let t=this.width,e=this.height,a=document.createElement("canvas");a.width=this.width,a.height=this.height,a.getContext("2d").drawImage(o,0,0),n([a,t,e])},o.src=a}))}catch(t){b(t,"getNewImage")}}("https://raw.githubusercontent.com/TheElderFallouts/wwbtp/main/PP/"+n+"/",t[e].name);E.images.push(new u(t[e].name,t[e].x,t[e].y,...a)),P("loadProgress").value=P("loadProgress").value+1,P("loadProgress").value==P("loadProgress").max&&P("loadProgress").remove()}function T(){return p}function G(t,e,n,a,o){try{if(!t||!e||!n.length)return void b("EMPTY","Draw");e[1].drawImage(t,...Array.from(function(t){try{return Array.from([t.width/2,t.height/2],(t=>Math.round(t)))}catch(t){b(t,"GetObjectMid")}}(e[0]),((t,e)=>Math.round(n[e]-o[e])*T()+t-T()/2)),...Array.from(a,((t,e)=>t*T())))}catch(t){b(t,"Draw")}}async function L(){let t=await c();const n=await e(E.images,t);for(let e of n)l(e,t),t[0]==x[0]&&t[1]==x[1]||(x=t,r().getState().gui.mute||s({type:"s/TGL_MUTE"}),C(e.GetPixColorData(e.RealData,e.GetIndex(t[0]-e.x,t[1]-e.y))),s({type:"s/SELECT_HOLD_PAINT",value:0,immediate:0}));y[0][1].clearRect(0,0,y[0][0].width,y[0][0].height),y[0][1].fillStyle="#95a3b0",y[0][1].fillRect(0,0,y[0][0].width,y[0][0].height),y[1][1].clearRect(0,0,y[0][0].width,y[0][0].height);let a=E.images.filter((e=>async function(t,e,n){return e[0]-n<t.x&&e[1]-n<t.y&&e[0]+n>t.x+t.width&&e[1]+n>t.y+t.height}(e,t,4500)));a.forEach((e=>G(e.data,y[0],[e.x,e.y],[e.width,e.height],t))),a.forEach((e=>G(e.errors,y[1],[e.x,e.y],[e.width,e.height],t)))}function k(t){t.shiftKey?(console.log("Клавиша Shift нажата"),s({type:"s/SELECT_HOLD_PAINT",value:0,immediate:0})):console.log("Клавиша Shift не нажата")}function z(t){!async function(t,e,n){let a=70,o="resizeCanvass";t+=n[0],e+=n[1];try{for(let n in y)t<a||e<a?(S("the width or height is too small. --\x3e>|| ",o),y[n][0].width=t<=a?a:t,y[n][0].height=e<=a?a:e):t>=window.innerWidth-a||e>=window.innerHeight-a?(S("the width or height is too big. --\x3e>|| ",o),y[n][0].width=t>=window.innerWidth-a?window.innerWidth-a:t,y[n][0].height=e>=window.innerHeight-a?window.innerHeight-a:e):(y[n][0].width=t,y[n][0].height=e),y[n][1].imageSmoothingEnabled=!1;localStorage.setItem("size",[y[0][0].width,y[0][0].height])}catch(t){b(t,o)}}(window.innerWidth-t.pageX,t.pageY,v)}async function M(){localStorage.size||localStorage.setItem("size",[500,300]);const t=await async function(){const t=await async function(){try{const t=await fetch("https://api.github.com/repos/"+g+"/"+f+"/commits");if(!t.ok)throw new Error("Ошибка HTTP: "+t.status);return await t.json()}catch(t){return console.error("Ошибка при получении коммитов:",t.message),[]}}();if(Array.isArray(t))return console.log(t[0].sha),t[0].sha;console.error("Ответ не содержит массив коммитов:",t)}();var e;E.loadNewImages=localStorage.getItem("commit")!=t&&(e=t,localStorage.setItem("commit",e),!0),await async function(t){try{let e=await async function(t){try{return new Promise((e=>{fetch(t).then((t=>{e(t.json())}))}))}catch(t){b(t,"GetTeampletList")}}("https://raw.githubusercontent.com/TheElderFallouts/wwbtp/main/PP/templates/"+t+".json");I("progress",{id:"loadProgress",max:Object.keys(e).length,value:"0",style:"position: absolute;left: 0px;right: 0px;margin: 0px auto;top: 0px;display: block;padding: 11px;accent-color: lime;"});for(let n in e)A(e,n,t)}catch(t){console.error(t),b(t,"LOADAllImages")}}(i("canvasIdent")),await L(),document.addEventListener("mousemove",L),document.addEventListener("keydown",k),y[y.length-1][0].onmousedown=t=>{document.removeEventListener("mousemove",L),v=[],v[0]=y[0][0].width-(window.innerWidth-t.pageX),v[1]=y[0][0].height-t.pageY,document.addEventListener("mousemove",z),document.onmouseup=async()=>{document.removeEventListener("mousemove",z),document.addEventListener("mousemove",L)}}}window.pixelPlanetEvents.addListener("setscale",((t,e)=>{p=t,L()})),window.registerPixelUpdates(((t,n,a)=>async function(t,n,a){const o=await c(),r=i("canvasSize")/2,s=i("palette").rgb,h=await e(E.images,o);for(let e of h)a.forEach(((o,i)=>{d(e,t,n,a[i],r,s)}));DrawAllTemp()}(t,n,a))),window.addEventListener("load",(function(){setTimeout((async()=>{await async function(){try{const t=localStorage.getItem("size").split(",")?localStorage.getItem("size").split(","):[256,256];for(let e in w)D(w[e],...t),y[e][1].imageSmoothingEnabled=!1}catch(t){b(t,"crateAllCanvass")}}(),M();const t=document.createElement("style");t.innerHTML="\n        @keyframes blink {\n            0% { opacity: 0.0; }\n            50% { opacity: 1.0; }\n            100% { opacity: 0.0; }\n        }\n\n        #cal {\n            animation: blink 5s infinite;\n        }\n        ",(document.head||document.getElementsByTagName("head")[0]).appendChild(t);let e=i("canvasIdent");setInterval((()=>{e!==i("canvasIdent")&&(document.removeEventListener("mousemove",z),document.removeEventListener("mousemove",L),E=new m,e=i("canvasIdent"),M())}),1e3)}),2e3)}))})();
